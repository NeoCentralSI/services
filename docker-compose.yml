# ─────────────────────────────────────────────────────────────────
# Production Docker Compose – Tugas Akhir Backend
# Usage:
#   1. Copy .env.example → .env and fill in all values
#   2. docker compose up -d
# ─────────────────────────────────────────────────────────────────
services:

  # ── App ────────────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tka-app
    image: tka-backend:latest
    restart: unless-stopped
    env_file: .env
    environment:
      NODE_ENV: production
      REDIS_URL: redis://redis:6379
      GOTENBERG_URL: http://gotenberg:3000
    ports:
      - "3000:3000"
    volumes:
      - uploads:/app/uploads
    depends_on:
      redis:
        condition: service_healthy
      gotenberg:
        condition: service_started
    networks:
      - tka-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ── Redis ──────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: tka-redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - tka-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Gotenberg (PDF) ────────────────────────────────────────────
  gotenberg:
    image: gotenberg/gotenberg:8
    container_name: tka-gotenberg
    restart: unless-stopped
    command:
      - gotenberg
      - "--chromium-disable-routes=false"
      - "--api-timeout=60s"
    networks:
      - tka-net
    # Not exposed externally – only reachable by the app container

# ─────────────────────────────────────────────────────────────────
volumes:
  uploads:
  redis-data:

networks:
  tka-net:
    driver: bridge